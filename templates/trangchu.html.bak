{% extends "index.html" %}

{% block content %}
<div style="padding: 20px;">
    <div style="margin-bottom: 30px; text-align: center; background: #f4f4f4; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
        <h3 style="color: #a92326;">H·ªá th·ªëng t√¨m ki·∫øm s·∫£n ph·∫©m (Demo SQLi)</h3>
        <input type="text" id="txtSearch" style="width: 60%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" 
               placeholder="Nh·∫≠p chu·ªói UNION ƒë·ªÉ l·∫•y d·ªØ li·ªáu User...">
        <div style="margin-top: 10px;">
            <button onclick="doSearch('/api/search-unsafe')" style="background: #ff4d4d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">T√¨m ki·∫øm KH√îNG AN TO√ÄN</button>
            <button onclick="doSearch('/api/search-safe')" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px;">T√¨m ki·∫øm AN TO√ÄN</button>
        </div>
    </div>

    <h2 style="margin-bottom: 20px; text-align: center;" id="list-title">Danh s√°ch s·∫£n ph·∫©m</h2>

    <div class="product-grid" id="product-container">
        {% if products %}
            {% for p in products %}
                <div class="product-card" onclick="window.location.href='{{ url_for('product_detail', product_id=p.id) }}'">
                    <div class="product-image-wrapper">
                        <img src="{{ p.image if p.image else url_for('static', filename='images/khongcoanh.png') }}" 
                             alt="{{ p.title }}" onerror="this.src='/static/images/khongcoanh.png'">
                    </div>
                    <div class="product-info">
                        <div class="product-title" style="font-weight: bold;">{{ p.title }}</div>
                        <p class="product-price" style="color: #a92326;">${{ p.price }}</p>
                        <p style="font-size: 12px; color: #666;">Danh m·ª•c: {{ p.category }}</p>
                        <small>‚≠ê {{ p.rating_rate }} ({{ p.rating_count }} ƒë√°nh gi√°)</small>
                    </div>
                    <button class="btn-add-cart">üõí Th√™m v√†o gi·ªè</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<script>
function doSearch(endpoint) {
    const keyword = document.getElementById('txtSearch').value;
    const container = document.getElementById('product-container');
    const titleHeader = document.getElementById('list-title');

    if (!keyword.trim()) { window.location.reload(); return; }

    container.innerHTML = '<p style="text-align: center; width: 100%;">ƒêang truy v·∫•n SQL...</p>';

    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keyword: keyword})
    })
    .then(res => res.json())
    .then(data => {
        container.innerHTML = '';
        
        // KI·ªÇM TRA N·∫æU DATA KH√îNG PH·∫¢I L√Ä M·∫¢NG (ƒê√ÇY L√Ä CH·ªñ G√ÇY L·ªñI FOREACH)
        if (!Array.isArray(data)) {
            titleHeader.innerText = "TH√îNG B√ÅO T·ª™ DATABASE (DEBUG)";
            container.innerHTML = `
                <div style="width: 100%; padding: 20px; background: #fff0f0; border: 2px dashed red; color: red;">
                    <h4>Ph·∫£n h·ªìi kh√¥ng ph·∫£i d·∫°ng danh s√°ch:</h4>
                    <pre style="text-align: left; background: #eee; padding: 10px;">${JSON.stringify(data, null, 2)}</pre>
                    <p><b>G·ª£i √Ω:</b> N·∫øu th·∫•y l·ªói "mismatch column", h√£y ki·ªÉm tra l·∫°i s·ªë l∆∞·ª£ng c·ªôt trong l·ªánh UNION.</p>
                </div>`;
            return;
        }

        if (data.length === 0) {
            container.innerHTML = '<p style="text-align: center; width: 100%;">Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p.</p>';
            return;
        }

        titleHeader.innerText = endpoint.includes('unsafe') ? "D·ªÆ LI·ªÜU TRUY XU·∫§T TH√ÄNH C√îNG" : "K·∫øt qu·∫£ t√¨m ki·∫øm";

        data.forEach(p => {
    container.innerHTML += `
        <div class="product-card" onclick="window.location.href='/product/${p.id}'">
            <div class="product-image-wrapper">
                <img src="${p.image || '/static/images/khongcoanh.png'}" onerror="this.src='/static/images/khongcoanh.png'">
            </div>
            <div class="product-info">
                <div class="product-title" style="color: blue; font-weight: bold;">${p.title || 'N/A'}</div>
                <p class="product-price" style="color: red;">$${p.price || 0}</p>
            </div>
            <button class="btn-add-cart" 
                onclick="event.stopPropagation(); addToCart({
                    id: ${p.id},
                    title: '${(p.title || '').replace(/'/g, "\\'")}', 
                    price: ${p.price || 0},
                    image: '${p.image || '/static/images/khongcoanh.png'}'
                })">
                üõí Th√™m v√†o gi·ªè
            </button>
        </div>`;
});
    })
    .catch(err => {
        container.innerHTML = `<p style="color: red;">L·ªói k·∫øt n·ªëi Server: ${err}</p>`;
    });
}
</script>
{% endblock %}